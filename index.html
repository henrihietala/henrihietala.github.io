<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="henrihietala.github.io : .NET / AngularJS developer blog">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>henrihietala.github.io</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/henrihietala">View on GitHub</a>

          <h1 id="project_title">henrihietala.github.io</h1>
          <h2 id="project_tagline">.NET / AngularJS developer blog</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a name="how-to-deploy-azure-cloud-services-using-octopus-deploy" class="anchor" href="#how-to-deploy-azure-cloud-services-using-octopus-deploy"><span class="octicon octicon-link"></span></a>How to deploy Azure Cloud Services using Octopus Deploy</h2>

<p>I am developing an ASP.NET MVC application which consists of two Azure Cloud Services, <strong>web role</strong> and <strong>worker role</strong> (two different solutions).</p>

<p>The Continuous Integration part is handled with JetBrains <strong>TeamCity</strong> and <strong>Octopus Deploy</strong>. Those are some pretty neat tools but not so well documented in terms of Azure Cloud Service deployment.</p>

<h3>
<a name="teamcity-to-octopus" class="anchor" href="#teamcity-to-octopus"><span class="octicon octicon-link"></span></a>TeamCity to Octopus</h3>

<ul>
<li>Install OctoPack NuGet to your WebRole/WebWorker project. TeamCity has an option to automatically create OctoPacks of projects that have the <a href="https://www.nuget.org/packages/OctoPack/">OctoPack NuGet</a> installed. Make sure you turn that on.</li>
</ul>

<pre><code>PM &gt; Install-Package OctoPack
</code></pre>

<ul>
<li><p>Create a .nuspec file to your WebRole/WebWorker project. A .nuspec file is a manifest that uses XML to describe your package.</p></li>
<li><p>Publish packages to Octopus using TeamCity</p></li>
</ul>

<h3>
<a name="octopus-to-azure-deployment" class="anchor" href="#octopus-to-azure-deployment"><span class="octicon octicon-link"></span></a>Octopus to Azure deployment</h3>

<p>First you should create a step template that has a couple of parameters. This is handy if you need to deploy more than one Cloud Service using the same Azure Subscription Id, Storage Account etc. If you need to deploy only one cloud service, don't bother doing a step template but just a normal "Deploy to Azure" step in your process.</p>

<p>Add Custom PowerShell script to the template. This will allow you to execute custom PS scripts in three different phases of your deployment process: Pre-Deploy, Deployment, Post-Deploy.</p>

<p>You are interested in executing custom PowerShell script in <strong>Deployment</strong> phase. This will be executed after your .config transformations (connectionString, appSettings..). The script you wan't to execute will package your project into a Azure Cloud Service <strong>.cspkg</strong> package that can be deployed to Azure. Octopus will automatically find the .cspkg file so all you need to worry about is generating it (no matter where).</p>

<p>Go to your Script Modules and add a module that contains the following function:</p>

<pre><code>Function generatePackage() {
  &lt;# I will add the script later on. #&gt;
}
</code></pre>

<p>You can enable the script module for your Octopus Project by clicking the "Configure script modules for this project" link in the project page.</p>

<p>After you have added and enabled the script module, you can call its functions in your Deployment Step template. Call the generatePackage function in Deployment phase like this:</p>

<pre><code>generatePackage -workingDirectory ...
</code></pre>

<p><em>To be continued...</em></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
